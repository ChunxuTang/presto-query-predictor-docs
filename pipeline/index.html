



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.13">
    
    
      
        <title>ML Pipeline - Presto Query Predictor</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.077507d7.min.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/palette.ff0a5ce4.min.css">
      
      
        
        
        <meta name="theme-color" content="#02a6f2">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="light-blue" data-md-color-accent="pink">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ml-pipeline" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href=".." title="Presto Query Predictor" class="md-header-nav__button md-logo" aria-label="Presto Query Predictor">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Presto Query Predictor
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              ML Pipeline
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Presto Query Predictor" class="md-nav__button md-logo" aria-label="Presto Query Predictor">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Presto Query Predictor
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../analysis/" title="Log Analysis" class="md-nav__link">
      Log Analysis
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        ML Pipeline
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" title="ML Pipeline" class="md-nav__link md-nav__link--active">
      ML Pipeline
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datasets" class="md-nav__link">
    Datasets
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-transformation" class="md-nav__link">
    Data Transformation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model-training" class="md-nav__link">
    Model Training
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../serving/" title="Model Serving" class="md-nav__link">
      Model Serving
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../architecture/" title="Architecture" class="md-nav__link">
      Architecture
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../faq/" title="FAQ" class="md-nav__link">
      FAQ
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#datasets" class="md-nav__link">
    Datasets
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-transformation" class="md-nav__link">
    Data Transformation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model-training" class="md-nav__link">
    Model Training
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="ml-pipeline">ML Pipeline</h1>
<h2 id="overview">Overview</h2>
<p>A typical machine learning pipeline may contain data loading, data transformation,
training(train-dev)/testing datasets splitting, vectorization, classification/
regression, etc.</p>
<p>In the <code>presto-query-predictor</code> package, the <code>Pipeline</code> class provides a
high-level interface to create a model training pipeline without the necessity to
program in each detailed step. The dataset path or dataset, the transformer
config path, and the trainer config path are the input parameters for a <code>Pipeline</code>
instance. Below is an example to use the class to create a CPU model training
pipeline.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">query_predictor.predictor.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>

<span class="c1"># Path of the embedded fake dataset.</span>
<span class="c1"># The path can be replaced by other datasets in practical usages.</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="n">parent_dir</span> <span class="o">/</span> <span class="s2">&quot;query_predictor/datasets/data/tpch.csv&quot;</span>

<span class="c1"># Paths of the default transformer and trainer configs.</span>
<span class="c1"># The paths should be replaced by other configs in practical usages.</span>
<span class="n">transformer_config_path</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">parent_dir</span> <span class="o">/</span> <span class="s2">&quot;query_predictor/conf/transformer.yaml&quot;</span>
<span class="p">)</span>
<span class="n">cpu_trainer_config_path</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">parent_dir</span> <span class="o">/</span> <span class="s2">&quot;query_predictor/conf/trainer-cpu.yaml&quot;</span>
<span class="p">)</span>

<span class="c1"># Runs the pipeline to train a model to predict cpu time.</span>
<span class="n">cpu_pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span>
    <span class="n">data_path</span><span class="o">=</span><span class="n">data_path</span><span class="p">,</span>
    <span class="n">transformation_required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">transformer_config_path</span><span class="o">=</span><span class="n">transformer_config_path</span><span class="p">,</span>
    <span class="n">trainer_config_path</span><span class="o">=</span><span class="n">cpu_trainer_config_path</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">cpu_pipeline</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>

<span class="n">pp</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">PrettyPrinter</span><span class="p">()</span>
<span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">cpu_pipeline</span><span class="o">.</span><span class="n">report</span><span class="p">)</span>
</code></pre></div>


<h2 id="datasets">Datasets</h2>
<p>The package contains a faked dataset created with some TPC-H SQL queries. The
faked dataset has 22 samples with columns: <em>query_id, user_, source, environment,
catalog, query_state, query, peak_memory_bytes, and cpu_time_ms</em>. The dataset
can be loaded through the <code>load_tpch</code> method.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">query_predictor.datasets</span> <span class="kn">import</span> <span class="n">load_tpch</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">load_tpch</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>


<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The faked dataset is for demo purposes only. You need to train models from
some specific Presto request logs for production purposes.</p>
</div>
<h2 id="data-transformation">Data Transformation</h2>
<p>After loading a raw Presto request log dataset, we need to transform the dataset,
e.g. converting SQL queries to lowercase, creating prediction labels, etc. The
package provides a <code>DataTransformer</code> class for data transformation. The required
transformations are provided through a transformer configuration file.</p>
<div class="codehilite"><pre><span></span><code><span class="nt">transformers</span><span class="p">:</span>               <span class="c1"># The transformations executed on the dataset</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">drop_failed_queries</span>     <span class="c1"># Drops failed queries whose query state is FAILURE</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">create_labels</span>           <span class="c1"># Creates prediction labels for CPU time and peak memory bytes</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">to_lower_queries</span>        <span class="c1"># Converts SQL queries to lowercase</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">select_training_columns</span> <span class="c1"># Removes unnecessary columns</span>
<span class="nt">persist</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>               <span class="c1"># Whether the dataset after transformations should be persisted or not</span>
<span class="nt">persist_path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">clean.csv</span>     <span class="c1"># Persistence path</span>
</code></pre></div>


<h2 id="model-training">Model Training</h2>
<p>We apply data vectorization to the query strings in the transformed dataset.
For now, based on the <a href="https://scikit-learn.org/stable/"><code>scikit-learn</code></a> vectorizers, the package supports</p>
<ul>
<li><code>DataCountVectorizer</code> - token count approach</li>
<li><code>DataTfidfVectorizer</code> - TF-IDF (term frequency-inverse document frequency) approach</li>
</ul>
<p>After vectorization, we'll split the dataset to training and testing datasets and
apply specific classification algorithms.</p>
<ul>
<li><code>RandomForestClassifier</code> - A random forest classifier based on the <code>scikit-learn</code> package.</li>
<li><code>LogisticRegressionClassifier</code> - A logistic regression classifier based on the <code>scikit-learn</code> package.</li>
<li><code>XGBoostClassifier</code> - An XGBoost classifier based on the <code>xgboost</code> package.</li>
</ul>
<p>Any contributions to more classifiers are welcome!</p>
<p>Both the vectorizer's and the classifier's parameters can be provided through a
trainer configuration file. An example of training a CPU model is shown below.</p>
<div class="codehilite"><pre><span></span><code><span class="nt">label</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cpu_time_label</span>                 <span class="c1"># Predictiona label: cpu_time_label or peak_memory_label</span>
<span class="nt">feature</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">query</span>                        <span class="c1"># Feature column</span>
<span class="nt">vectorizer</span><span class="p">:</span>       
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">tfidf</span>                         <span class="c1"># Vectorizer type: tfidf or count</span>
  <span class="nt">params</span><span class="p">:</span>                             <span class="c1"># Params for the vectorizer, following scikit-learn parameters.</span>
    <span class="nt">max_features</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>
    <span class="nt">min_df</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="nt">max_df</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.8</span>
  <span class="nt">persist</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>                       <span class="c1"># Whether the vectorizer trained should be persisted or not</span>
  <span class="nt">persist_path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">models/vec-cpu.bin</span>    <span class="c1"># Persistence path</span>
<span class="nt">test_size</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.2</span>                        <span class="c1"># Testing dataset proportion during splitting</span>
<span class="nt">classifier</span><span class="p">:</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">XGBoost</span>                       <span class="c1"># Classifier type</span>
  <span class="nt">params</span><span class="p">:</span>                             <span class="c1"># Params for the classifier</span>
    <span class="nt">max_depth</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
    <span class="nt">objective</span><span class="p">:</span> <span class="s">&#39;binary:logistic&#39;</span>
  <span class="nt">persist</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>                       <span class="c1"># Whether the model trained should be persisted or not</span>
  <span class="nt">persist_path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">models/model-cpu.bin</span>  <span class="c1"># Persistence path</span>
</code></pre></div>


<p>After the training, a CPU model should be generated in the <code>models/</code> folder.
This model can be used to predict CPU usages of future Presto requests.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The vectorizer's and classifier's parameters are for demo purposes. They are
not optimized. The parameters usually require tuning when changed to another dataset.</p>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../analysis/" title="Log Analysis" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Log Analysis
              </div>
            </div>
          </a>
        
        
          <a href="../serving/" title="Model Serving" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Model Serving
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.2d1db4bd.min.js"></script>
      <script src="../assets/javascripts/bundle.6627ddf3.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.5eca75d3.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>